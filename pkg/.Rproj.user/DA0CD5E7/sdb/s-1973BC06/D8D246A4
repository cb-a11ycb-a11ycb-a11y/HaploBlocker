{
    "collab_server" : "",
    "contents" : "#' Extend-SNP\n#'\n#' Function to add single SNPs to each block\n#' @param dhm haploid SNP-dataset\n#' @param blocklist blocklist created by blocklist_calculcation algorithm\n#' @param window_sequence_list sequence of predefined windows (default: NULL ;per row: start$snp, end$snp, length, length - merging_error, start$bp, end$bp)\n#' @param indi number of haplotypes in the dataset\n#' @param nwindow number of windows in the dataset\n#' @param bp_map vector of positions for each SNP in bp (default: NULL - all 0)\n#' @param max_extending_diff_snp Maximum number of SNPs with variants in SNP-extending-algorithm (step V; default: 0)\n#' @param extending_ratio_snp Minimum ratio of SNPs with only one allele to those with variants (default: Inf)#' @param off_node_addition If TRUE use off-variant-identification (default: FALSE)\n#' @export\n\n\nextend_snp <- function(blocklist, indi, nwindow, dhm, window_sequence_list, bp_map, max_extending_diff_snp=0, extending_ratio_snp=Inf){\n  max_l <- 0\n  for(index in 1:length(window_sequence_list)){\n    if(is.matrix(window_sequence_list[[index]])){\n      max_l <- max(max_l, window_sequence_list[[index]][,3])\n    }\n\n  }\n  prev <- numeric(max_l)\n  extensions_done <- 0\n  for(index in 1:length(blocklist)){\n    activ <- blocklist[[index]]\n\n    #Verlaengerung nach Vorne\n    if(activ[[2]]$window > 1 ){\n\n      diff <- 0\n      same <- 0\n      extension_length <- 0\n      max_diff <- 0\n      position_diff <- NULL\n      position <- activ[[2]]$snp -1\n      while(diff <= max_extending_diff_snp && position>0){\n        count <- sum(dhm[position, activ[[6]]]==dhm[position, 1])\n        if(count==activ[[5]] || count==0){\n          same <- same +1\n          prev[same+diff] <- dhm[position, activ[[6]][1]]\n        } else{\n          diff <- diff + 1\n          position_diff <- c(position, position_diff)\n        }\n        if(same/diff >= max_diff){\n          extension_length <- activ[[2]]$snp - position\n          max_diff <- same/diff\n        }\n        position <- position -1\n      }\n\n      if(max_diff >= extending_ratio_snp){\n        if(extension_length==max_l){\n          cat(\"SNP-extension over full window. That is not supposed to happen\\n\")\n        }\n        extensions_done <- extensions_done +1\n        activ[[2]]$snp <- activ[[2]]$snp - extension_length\n        activ[[2]]$bp <- bp_map[activ[[2]]$snp]\n        text <- paste(\"SNP-Extension:\",activ[[2]]$snp,\"_\",  activ[[2]]$snp + extension_length-1, sep=\"\")\n        activ[[1]] <- c(text, activ[[1]])\n        #activ[[4]] <- c(prev[activ[[2]]$window + 1:extension_length -1],activ[[4]])\n\n        blocklist[[index]] <- activ\n      }\n\n    }\n\n    # Verlaengerung nach Hinten\n    activ <- blocklist[[index]]\n    if(activ[[3]]$window < nwindow[activ[[12]]] ){\n\n      diff <- 0\n      same <- 0\n      extension_length <- 0\n      max_diff <- 0\n      position_diff <- NULL\n      position <- activ[[3]]$snp +1\n      while(diff <= max_extending_diff_snp && position<= max(window_sequence_list[[activ[[12]]]][,2])){\n        count <- sum(dhm[position, activ[[6]]]==dhm[position, 1])\n        if(count==activ[[5]] || count==0){\n          same <- same +1\n          prev[same+diff] <- dhm[position, activ[[6]][1]]\n        } else{\n          diff <- diff + 1\n          position_diff <- c(position, position_diff)\n        }\n        if(same/diff >= max_diff){\n          extension_length <- position - activ[[3]]$snp\n          max_diff <- same/diff\n        }\n\n        position <- position +1\n      }\n\n      if(max_diff >= extending_ratio_snp){\n        if(extension_length==max_l){\n          cat(\"SNP-extension over full window. That is not supposed to happen\\n\")\n        }\n        extensions_done <- extensions_done +1\n        activ[[3]]$snp <- activ[[3]]$snp + extension_length\n        activ[[3]]$bp <- bp_map[activ[[3]]$snp]\n        text <- paste(\"SNP-Extension:\",activ[[2]]$snp - extension_length+1,\"_\",  activ[[2]]$snp, sep=\"\")\n        activ[[1]] <- c(activ[[1]], text)\n        #activ[[4]] <- c(activ[[4]],  prev[activ[[3]]$window + 1:extension_length - extension_length])\n        blocklist[[index]] <- activ\n\n      }\n\n    }\n\n  }\n\n  return(blocklist)\n}\n",
    "created" : 1523363152480.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "323837709",
    "id" : "D8D246A4",
    "lastKnownWriteTime" : 1524223852,
    "last_content_update" : 1524223852016,
    "path" : "C:/Users/tpook/Desktop/R-Stuff/HaploBlocker/R/extend_snp.R",
    "project_path" : "R/extend_snp.R",
    "properties" : {
        "tempName" : "Untitled5"
    },
    "relative_order" : 71,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}